<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title></title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/flatly.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
padding-top: 50px;
padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar) */
.section h2 {
padding-top: 55px;
margin-top: -55px;
}
.section h3 {
padding-top: 55px;
margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
color: black;
}
/* some padding for disqus */
#disqus_thread {
margin-top: 45px;
}
</style>
<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Flammability</a>
      </div>
      <div class="navbar-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Overview</a></li>

          <li class="dropdown">
            <a href="data-prep" class="dropdown-toggle" data-toggle="dropdown">Data Prep <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li><a href="clim_resample_2km_1km.html">clim_resample_2km_1km.R</a></li>
              <li><a href="clim_1km_clip2ak.html">clim_1km_clip2ak.R</a></li>
              <li><a href="meanTPbyVegClass_CRU31.html">meanTPbyVegClass_CRU31.R</a></li>
              <li><a href="meanTPbyVegClass_CMIP5.html">meanTPbyVegClass_CMIP5.R</a></li>
            </ul>

          <li class="dropdown">
            <a href="gbm-flammability" class="dropdown-toggle" data-toggle="dropdown">GBM Flammability <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">GBM Modeling</li>
              <li><a href="gbm.html">gbm.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Flammability maps</li>
              <li><a href="gbm_flam_prep.html">gbm_flam_prep.R</a></li>
              <li><a href="gbm_flam_maps.html">gbm_flam_maps.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">ALFRESCO prep</li>
              <li><a href="duplicate_flam_maps.html">duplicate_flam_maps.R</a></li>
              <li><a href="FlammabilityMapMultipliers.html">FlammabilityMapMultipliers.R</a></li>
            </ul>

          <li class="dropdown">
            <a href="alfresco" class="dropdown-toggle" data-toggle="dropdown">ALFRESCO <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Main scripts</li>
              <li><a href="AlfrescoCalibration.html">AlfrescoCalibration.R</a></li>
              <li><a href="AlfrescoFRP.html">AlfrescoFRP.R</a></li>
              <li><a href="fseByVeg.html">fseByVeg.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Supporting scripts</li>
              <li><a href="obs_fire_setup.html">obs_fire_setup.R</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Functions</li>
              <li><a href="histPrep.html">histPrep.R</a></li>
              <li><a href="fireSizePlot.html">fireSizePlot.R</a></li>
              <li><a href="AByearPlot.html">AByearPlot.R</a></li>
              <li><a href="CABvsFSPlot.html">CABvsFSPlot.R</a></li>
              <li><a href="CABvsTimePlot.html">CABvsTimePlot.R</a></li>
            </ul>

          <li class="dropdown">
            <a href="apps" class="dropdown-toggle" data-toggle="dropdown">Apps <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">ALFRESCO launcher</li>
              <li class="divider"></li>
              <li class="dropdown-header">Results app</li>
            </ul>

          <li><a href="http://leonawicz.github.io">All Projects</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <a class="btn btn-link" href="https://github.com/leonawicz/Flammability">
            <i class="fa fa-github fa-lg"></i>
            Github
          </a>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>



<div id="section" class="section level2">
<h2></h2>
</div>
<div id="section-1" class="section level2">
<h2></h2>
</div>
<div id="fsebyveg.r" class="section level2">
<h2>fseByVeg.R</h2>
<p>The <code>fseByVeg.R</code> script carries out post-processing of ALFRESCO simulation outputs. It is assumed that <code>AlfrescoCalibration.R</code> has already executed. This and any other post-processing <strong>R</strong> script are always run secondary to the primary script.</p>
<p>The script extracts fire event sizes (FSE) from ALFRESCO output fire scar geotiffs for each simulation replicate, conditional on vegetation class, and combines the modeled FSE values with similarly extracted historical observations of vegetation-specific FSE. The hardcoded vegetation classification includes separate tundra types (alpine, shrub, graminoid, and wetland) and an aggregate forest type (black spruce, white spruce, and deciduous trees). Hardcoded years are currently 1950 - 2009.</p>
<p>An <strong>R</strong> workspace file containing a data frame of veg-specific FSE is attached to an email which is sent from the Atlas cluster to intended recipients as part of the broader SLURM process. This script is called by the SLURM script, <code>CompileData.slurm</code> after the initial post-processing script, <code>AlfrescoCalibration.R</code> has run.</p>
</div>
<div id="r-code" class="section level2">
<h2>R code</h2>
<div id="setup" class="section level3">
<h3>Setup</h3>
<pre class="sourceCode r"><code class="sourceCode r">comArgs &lt;-<span class="st"> </span><span class="kw">commandArgs</span>(<span class="ot">TRUE</span>)
if (<span class="kw">length</span>(comArgs &gt;<span class="st"> </span><span class="dv">0</span>)) {
    arg.mat &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, <span class="kw">strsplit</span>(comArgs, <span class="st">&quot;=&quot;</span>))
    <span class="kw">options</span>(<span class="dt">warn =</span> -<span class="dv">1</span>)
    arg.char &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">is.na</span>(<span class="kw">as.numeric</span>(arg.mat[, <span class="dv">2</span>])))
    <span class="kw">options</span>(<span class="dt">warn =</span> <span class="dv">0</span>)
    if (<span class="kw">length</span>(arg.char &gt;<span class="st"> </span><span class="dv">0</span>)) 
        arg.mat[arg.char, <span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;&#39;&quot;</span>, arg.mat[arg.char, <span class="dv">2</span>], <span class="st">&quot;&#39;&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)
    <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> <span class="kw">apply</span>(arg.mat, <span class="dv">1</span>, paste, <span class="dt">collapse =</span> <span class="st">&quot;=&quot;</span>)))
}
<span class="kw">cat</span>(comArgs)

<span class="kw">library</span>(raster)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(parallel)

mainDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(input, <span class="st">&quot;Maps&quot;</span>)</code></pre>
</div>
<div id="functions-fsebyveg" class="section level3">
<h3>Functions: fseByVeg</h3>
<p><code>fseByVeg</code> performs the basic operation of calculating FSEs by vegetation class and tabling the individual observations.</p>
<pre class="sourceCode r"><code class="sourceCode r">fseByVeg &lt;-<span class="st"> </span>function(i, v, f) {
    v[v !=<span class="st"> </span>i] &lt;-<span class="st"> </span><span class="ot">NA</span>
    x &lt;-<span class="st"> </span>f[!<span class="kw">is.na</span>(v) &amp;<span class="st"> </span>!<span class="kw">is.na</span>(f)]
    if (<span class="kw">length</span>(x)) 
        <span class="kw">return</span>(<span class="kw">data.frame</span>(<span class="dt">Vegetation =</span> i, <span class="dt">FSE =</span> <span class="kw">sort</span>(<span class="kw">as.numeric</span>(<span class="kw">tapply</span>(x, x, 
            length))))) else <span class="kw">return</span>(<span class="ot">NULL</span>)
}</code></pre>
</div>
<div id="functions-fsebyrep" class="section level3">
<h3>Functions: fseByRep</h3>
<p><code>fseByRep</code> is a parallel processing wrapper to <code>fseByVeg</code>, parallelized by simulation replicate.</p>
<pre class="sourceCode r"><code class="sourceCode r">fseByRep &lt;-<span class="st"> </span>function(d, mainDir, vid, v.veg, v.fid, <span class="dt">years =</span> <span class="dv">1950</span>:<span class="dv">2009</span>) {
    <span class="co"># hardcoded years</span>
    reps &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;_&quot;</span>, d -<span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;_&quot;</span>)
    files &lt;-<span class="st"> </span><span class="kw">list.files</span>(mainDir, <span class="dt">pattern =</span> <span class="kw">gsub</span>(<span class="st">&quot;expression&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">paste</span>(<span class="kw">bquote</span>(<span class="kw">expression</span>(<span class="st">&quot;^FireSc.*.&quot;</span>, 
        .(reps), <span class="st">&quot;.*.tif$&quot;</span>)), <span class="dt">collapse =</span> <span class="st">&quot;&quot;</span>)), <span class="dt">full =</span> T)
    yrs &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;FireScar_</span><span class="ch">\\</span><span class="st">d+_&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;.tif&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">basename</span>(files))))
    ord &lt;-<span class="st"> </span><span class="kw">order</span>(yrs)
    files &lt;-<span class="st"> </span>files[ord]
    yrs &lt;-<span class="st"> </span>yrs[ord]
    ind &lt;-<span class="st"> </span><span class="kw">which</span>(yrs %in%<span class="st"> </span>years)
    files &lt;-<span class="st"> </span>files[ind]
    yrs &lt;-<span class="st"> </span>yrs[ind]
    n &lt;-<span class="st"> </span><span class="kw">length</span>(yrs)
    dlist &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, n)
    for (k in <span class="dv">1</span>:n) {
        v.fid &lt;-<span class="st"> </span><span class="kw">getValues</span>(<span class="kw">raster</span>(files[k], <span class="dt">band =</span> <span class="dv">2</span>))
        if (!<span class="kw">all</span>(<span class="kw">is.na</span>(v.fid))) {
            dl &lt;-<span class="st"> </span><span class="kw">lapply</span>(vid, fseByVeg, <span class="dt">v =</span> v.veg, <span class="dt">f =</span> v.fid)
            dlist[[k]] &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbindlist</span>(dl))
            dlist[[k]]$Year &lt;-<span class="st"> </span>yrs[k]
        }
    }
    d &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbindlist</span>(dlist))
    d$Source &lt;-<span class="st"> &quot;Modeled&quot;</span>
    d$Replicate &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Rep&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="st">&quot;&quot;</span>, reps))
    d &lt;-<span class="st"> </span>d[, <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>)]
    d
}</code></pre>
</div>
<div id="functions-fsebyrepemp" class="section level3">
<h3>Functions: fseByRepEmp</h3>
<p><code>fseByRepEmp</code> is a basic wrapper to <code>fseByVeg</code> for empirical/historical observational FSE extraction.</p>
<pre class="sourceCode r"><code class="sourceCode r">fseByRepEmp &lt;-<span class="st"> </span>function(b, vid, v.veg, yrs) {
    n &lt;-<span class="st"> </span><span class="kw">nlayers</span>(b)
    dlist &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, n)
    for (k in <span class="dv">1</span>:n) {
        v.fid &lt;-<span class="st"> </span><span class="kw">getValues</span>(<span class="kw">subset</span>(b, k))
        if (!<span class="kw">all</span>(<span class="kw">is.na</span>(v.fid))) {
            dl &lt;-<span class="st"> </span><span class="kw">lapply</span>(vid, fseByVeg, <span class="dt">v =</span> v.veg, <span class="dt">f =</span> v.fid)
            dlist[[k]] &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbindlist</span>(dl))
            dlist[[k]]$Year &lt;-<span class="st"> </span>yrs[k]
        }
    }
    d &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbindlist</span>(dlist))
    d$Replicate &lt;-<span class="st"> </span>d$Source &lt;-<span class="st"> &quot;Observed&quot;</span>
    d &lt;-<span class="st"> </span>d[, <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>)]
    d
}</code></pre>
</div>
</div>
<div id="empirical-data-setup" class="section level1">
<h1>Empirical data setup</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="st">&quot;/big_scratch/shiny/obs_fire_setup.R&quot;</span>)
v.veg &lt;-<span class="st"> </span><span class="kw">getValues</span>(r)
v.veg[v.veg ==<span class="st"> </span><span class="dv">3</span> |<span class="st"> </span>v.veg ==<span class="st"> </span><span class="dv">4</span>] &lt;-<span class="st"> </span><span class="dv">2</span>  <span class="co"># 3 and 4 tree classes combine into class 2 to become &#39;forest&#39;, tundra types 1, 5, 6, and 7 remain as before</span>
vid &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">unique</span>(v.veg[!<span class="kw">is.na</span>(v.veg) &amp;<span class="st"> </span>v.veg &gt;<span class="st"> </span><span class="dv">0</span>]))
v.names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Alpine&quot;</span>, <span class="st">&quot;Forest&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;Shrub&quot;</span>, <span class="st">&quot;Graminoid&quot;</span>, <span class="st">&quot;Wetland&quot;</span>)</code></pre>
</div>
<div id="run-and-save-results" class="section level1">
<h1>Run and save results</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Process empirical data</span>
fse.emp &lt;-<span class="st"> </span><span class="kw">fseByRepEmp</span>(<span class="dt">b =</span> b.fid, <span class="dt">vid =</span> vid, <span class="dt">v.veg =</span> v.veg, <span class="dt">yrs =</span> yrs.all)
<span class="co"># Process modeled data</span>
num.reps &lt;-<span class="st"> </span><span class="dv">32</span>  <span class="co"># hardcoded</span>
fse.alf.list &lt;-<span class="st"> </span><span class="kw">mclapply</span>(<span class="dv">1</span>:<span class="kw">min</span>(num.reps, <span class="dv">32</span>), fseByRep, <span class="dt">mainDir =</span> mainDir, <span class="dt">vid =</span> vid, 
    <span class="dt">v.veg =</span> v.veg, <span class="dt">mc.cores =</span> <span class="kw">min</span>(num.reps, <span class="dv">32</span>))
fse.alf &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbindlist</span>(fse.alf.list))
d.fse.veg &lt;-<span class="st"> </span><span class="kw">rbind</span>(fse.emp, fse.alf)
d.fse.veg$Vegetation &lt;-<span class="st"> </span>v.names[d.fse.veg$Vegetation]
<span class="kw">save</span>(d.fse.veg, <span class="dt">file =</span> <span class="kw">file.path</span>(out, <span class="st">&quot;fseByVeg_df.RData&quot;</span>))

<span class="kw">sink</span>(<span class="dt">file =</span> <span class="kw">file.path</span>(out, <span class="st">&quot;message.txt&quot;</span>), <span class="dt">append =</span> <span class="ot">TRUE</span>)
<span class="kw">cat</span>(<span class="st">&quot;An R workspace file containing fire event sizes partitioned by vegetation class is attached.</span><span class="ch">\n</span><span class="st">&quot;</span>)
<span class="kw">sink</span>()</code></pre>
</div>

<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>
<script>
  // manage active state of menu based on current page
  $(document).ready(function () {
  
    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');
    
    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');
	  
  });
</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
